# 드래그 앤 드롭 기능

## DEMO

* [드래그앤드롭](../test/dnd.html)

## 사용 방법

드래그 기능을 사용할때에는 텍스트 드래그 선택 기능과 동시에 동작되지 않도록 하는것이 좋습니다.  

```html
<!--적절한 부모 element에 설정해 줍니다.-->
<div style="user-select: none"></div>
```

### 드래그 Element 설정

```html
<template>
    
    <!--드래그 설정-->
    <div data-dnd-group="드래그/드롭이 서로 호환(허용)되는 그룹 네이밍"
         data-drag-value="드롭 가능한지 비교할 값 (성공 여부 판별)"
         data-dnd-type="copy | move (default)"
         data-dnd-mode="dnd | mouse (default)">
    </div>
    <!--0.2.4 버전 부터 'as-dnd-mode' 대신 'data-dnd-mode' attribute를 사용합니다.-->
</template>
```

`data-dnd-type` 값은 드래그 시작할때 원본을 숨기는 기능을 설정합니다.    
- `data-dnd-type="move"` (default) : 드래그 도중 원본이 감춰지게 되어 마치 이동하고 있는것처럼 표현
- `data-dnd-type="copy"` : 드래그할때 드래그 원본도 보이기 상태로 계속 유지

`data-dnd-mode` 값은 드래그 앤 드롭 기능을 구현하는 알고즘을 지정합니다.
- `data-dnd-mode="mouse"` (default) : 마우스 이벤트를 이용하여 기능을 구현
- `data-dnd-mode="dnd"` : HTML 드래그 앤 드롭 API를 이용하여 기능을 구현

> 드래그할때 나타나는 이미지는 원본 이미지가 아닌 ghost 이미지 입니다.  
실제로 원본을 이동시키려면 드롭 결과를 원본에 별도로 적용해 주어야 합니다.  
방법은 아래 `드롭 이후 상태 처리` 항목에서 다시 설명합니다.


### 드롭 Element 설정
```html
<template>

    <!--드롭 설정-->
    <div data-dnd-group="드래그/드롭이 서로 호환(허용)되는 그룹 네이밍"
         data-drop-value="드롭 가능한지 비교할 값 (성공 여부 판별)"></div>

</template>
```
### 드래그 앤 드롭 가능한지 판별

드래그 element가 드롭 가능하려면 다음 두가지를 만족해야 합니다.
- 드래그 Element의 위치 (정확히는 마우스 위치)가 드롭 element의 크기 영역 안에 있어야 함
- 드래그 Element의 `data-drag-value` 값과 드롭 영역 element의 `data-drop-value` 값이 서로 같아야 함

성공적으로 드롭되었으면 `success` 이벤트가 발생합니다.  
드롭이 실패하면 `fail` 이벤트가 발생합니다.

### 드래그 앤 드롭 이벤트

드래그 앤 드롭이 끝나면 성공 여부에 따라 `success`, `fail` 이벤트가 drag, drop element 양쪽 모두에서 발생합니다.  
같은 값의 drag element가 드롭 영역 안에서 드롭된 경우 성공으로 간주됩니다.

```html
<template>

    <!--드래그 설정-->
    <div data-dnd-group="group1" data-drag-value="a" 
         onsuccess="" 
         onfail="">
    </div>

    <!--드롭 설정-->
    <div data-dnd-group="group1" data-drop-value="a"
         onsuccess=""
         onfail=""></div>

    <!--
    success, fail 이벤트 발송
     - dragend 후 드래그 element에서 발송함
     - drop 후 드롭 element에서 발송함
     - drag 요소, drop 요소 양쪽에서 모두 이벤트 받을 수 있음
    -->
    
</template>
```
드래그 앤 드롭 과정에서 발생하는 이벤트입니다.  

```html
<template>

    <!--드래그 설정-->
    <div data-dnd-group="group1" data-drag-value="a"
         ondragstart=""
         ondrag=""
         ondragend="">
    </div>

    <!--드롭 설정-->
    <div data-dnd-group="group1" data-drop-value="a"
         ondragenter=""
         ondragleave=""
         ondragover=""
         ondrop=""></div>

</template>
```

모든 이벤트에 대하여 `task:[이벤트]` 구문을 사용할 수 있습니다.

### 드래그 앤 드롭 이벤트 객체

드래그 앤 드롭 과정에서 발생된 이벤트 객체에는 다음 정보가 공통으로 제공됩니다.  
이 정보를 이용하여 드롭 이후의 상태를 설정할 수 있습니다.

```js
// event.detail 객체에는 드래그 앤 드롭 상태 정보가 포함됩니다.

event.detail = {
    event: event,
    
    // 시작, 끝 위치 정보
    position: {},

    // 드래그 정보
    dragGroup: 'data-dnd-group 설정값 (drag Element에 설정된 값)',
    dragValue: 'data-drag-value 설정값',
    // 드래그 되고있는 HTMLElement
    drag: dragElement,
    // Ghost 이미지를 표시하는 HTMLElement (v0.2.4 부터 추가됨)
    ghost: ghost,

    // 드롭 정보
    dropGroup: 'data-dnd-group 설정값 (drop Element에 설정된 값)',
    dropValue: 'data-drop-value 설정값',
    // 드롭 영역 HTMLElement
    drop: null
}
```

위치 정보는 `position` 객체에 있습니다.

```js

event.detail.position = {
    // 글로벌 좌표에 적용된 스케일 값
    scale,

    // 드래그 Element의 좌상단에서 마우스 위치까지 offsset
    shift: { x, y },
    
    // 드래그 시작될때 상태 값을 캡쳐
    start: {
        // 글로벌 좌표 (드래그 Element의 getBoundingClientRect 값임)
        global: { x, y, w, h },

        // 시각적 글로벌 좌표 (v0.2.4 부터 추가됨)
        globalVisual: {x, y},
        // global과 globalVisual 좌표간 차이 (v0.2.4 부터 추가됨)
        globalOffset: {x, y},
        
        // 자신의 원래 위치로부터 이동된 좌표 (translate)
        dist: {x, y}
    },
    
    // 드래그 중이거나 드래그 종료(드롭) 될때 상태 값을 캡쳐
    end: {
        // start 데이터와 내용 구성이 같습니다.
    },

    // 드롭 Element 정보
    dropOrigin: {
        // 글로벌 좌표 (드롭 영역 Element의 getBoundingClientRect 값임)
        global: { x, y, w, h },

        // 드롭 영역 Element의 시각적 글로벌 좌표 (v0.2.4 부터 추가됨)
        globalVisual: {x, y},
        // start.globalOffset 데이터와 같은 값 (v0.2.4 부터 추가됨)
        globalOffset: {x, y},

        // Drag Element 원래 위치로부터 드롭 영역 Element의 영점까지 거리
        // (Drag Element 원래 위치를 기준으로 계산된 값임)
        dist: {x, y}
    }
}

```

- 글로벌 좌표 (`global`): transform 변형이 적용되지 않은 상태의 좌상단 좌표값
- 시각적 글로벌 좌표 (`globalVisual`): transform 설정으로 변형된 상태의 좌상단 이동지점 좌표
- `dist`: 좌표 값이 아닌 이동량을 나타냄. `gsap`에 바로 사용할 수 있는 translate 값임.

>### 부모로부터 좌표가 아닌 자신의 원래 위치로부터 이동 값을 제공하는 이유
> 
>부모로부터 위치 좌표를 사용하지 않는 이유는  parent의 상태 (position, display)에 따라 오차가 발생하기 때문입니다.  
>최초 drag Element 좌표 기준으로 translate 하여 사용하는 것이 항상 같은 기준으로부터 값을 얻을 수 있어 안정적입니다.
> 
>이는 taskml에서 사용하는 `tween` 라이브러리 방식과 같아 드롭 이후 상태를 설정할때 호환이 잘됩니다.  

## 드롭된 이후 상태 처리
  
위에서 언급한 것처럼 드래그 앤 드롭 기능은 실제 drag element를 드래그 시키는것이 아닌 드래그 상태만 시뮬레이션 해주기 때문에 최종 결과는 별도로 처리해 주어야 합니다.  
이벤트 객체에 전달된 `position` 정보와 `tween` task를 이용하여 drag element의 최종 상태를 설정합니다.  

```html
<!--드래그 요소-->

<!--드롭 가능한 정답 요소이지만 드롭 밖 영역인 경우 오답 처리됨 -->
<div data-drag-value="answer" data-dnd-group="page1"
     task:fail="오답" task:success="정답">( O )</div>

<!--항상 드롭에 실패하는 오답이므로 susses 이벤트 처리는 필요 없음-->
<div data-drag-value="not answer" data-dnd-group="page1"
     task:fail="오답">( X )</div>

<!--드롭 영역-->
<div data-drop-value="answer" data-dnd-group="page1"></div>

<task id="정답">
    <script> showSuccess($args, $next); </script>
</task>
<task id="오답">
    <script> showFail($args, $next); </script>
</task>
```

### 드롭된 마지막 위치를 유지하는 경우 (move)

```js
function showSuccess($args, $next){
    move($args.event, $next);
}
function showFail($args, $next){
    move($args.event, $next);
}

function move(event, $next){
    // 마지막 위치로 이동
    const pos = event.detail.position.end.dist;
    gsap.set(event.target, pos);
    $next();
}
```

### (success) 드롭된 영역으로 이동되는 경우

`showSuccess` 함수가 호출되는 경우입니다.

```js
// 현재 드롭 위치에서 드롭된 영역의 특정 위치로 자연스럽게 자리를 잡습니다.
function showSuccess($args, $next){
    toDrop($args.event, $next);
}

// drop 후 drag 요소를 drop 요소 위치로 이동
function toDrop(event, $next){
    const position = event.detail.position;

    // 드래그 시작할때 이동 초기값
    let startPos = position.start.dist;

    // 드래그로 이동된 값
    const from = position.end.dist;

    // 사용자가 attribute에 설정(했다면) 보정값 찾기
    const drag = event.detail.drag;
    const offset = {
        x: parseInt(drag.dataset.offsetX || 0),
        y: parseInt(drag.dataset.offsetY || 0)
    }

    // drop 박스 위치
    const dropOrigin = position.dropOrigin.dist;
    const to = {
        x: startPos.x + dropOrigin.x + offset.x,
        y: startPos.y + dropOrigin.y + offset.y,
        onComplete: () => $next()
    }
    
    // drag end 위치에서 drop 박스 위치로 이동
    gsap.fromTo(drag, from, to);
    
    // 애니메이션 없이 바로 적용하려면 gsap.set 메서드 사용
    // gsap.set(drag, to);
}
```

### (fail) 처음 드래그 위치로 되돌아 가는 경우

`showFail` 함수가 호출되는 경우입니다.
```js
// 현재 드롭 위치에서 드래그되기 전 위치로 되돌아갑니다.
function showFail($args, $next){
    toOrigin($args.event, $next);
}

function toOrigin($args, $next){
    const position = event.detail.position;

    // drag end 위치에서
    const from = position.end.dist;

    // 드래그되기 전 원래 자리로 이동
    const to = {
        // x: 0, y: 0,
        ...position.start.dist,
        onComplete: () => $next()
    }

    const drag = event.detail.drag;
    gsap.fromTo(drag, from, to);

    // 애니메이션 없이 바로 적용하려면 gsap.set 메서드 사용
    // gsap.set(drag, to);
}
```

## 드롭된 이후 특별한 상황

### 시간 지연 후 드롭된 결과를 적용하는 경우

드롭 즉시 결과를 반영하지 않고 나중 시점에 적용하려고 하는 경우에는 
* 먼저 drag end 위치로 원본을 이동시켜 놓습니다.
* `showSuccess` 또는 `showFail` 함수에서 위치 데이터를 저장합니다.
* 필요할때 저장된 위치 데이터를 사용하여 tween 시켜 줍니다.

`showSuccess` 함수를 예로 들면
```js
function showSuccess($args, $next){
    save($args.event, $next);
}

// 나중에 사용하기 위해 데이터 임시 저장
function save(event, $next){
    const position = event.detail.position;
    
    // drag end 위치 바로 적용
    const from = position.end.dist;
    gsap.set(drag, from);

    // drop 박스 위치
    const drag = event.detail.drag;
    const dropOrigin = position.dropOrigin.dist;
    
    // 최종 위치는 저장해둠
    $js.drop = {
        target: drag, 
        to: dropOrigin
    }
    $next();
}
```

특정 시점에 다음과같이 최종 위치로 이동시킬 수 있습니다.
```html
...
<tween selector="$js.drop.target" selector-is-dom to="$js.drop.to"></tween>

<!--
    // 또는 스크립를 틍해서 호출
    gsap.to($js.drop.target, $js.drop.to);
    // delete $js.drop;
    $next();
-->
```

### Ghost 이미지를 이동(tween) 시킨 후 종료해야 할때 

다음과 같은 상황에서는 ghost 이미지를 tween 시켜줘야 합니다.
- `data-dnd-type="copy"` 설정일때 드롭 실패한 경우 
- drag 요소는 항상 제자리에 고정되어 있어야 하므로
- 제자리로 되돌아가는(fail) tween을 위해 대신 움직임을 보여줄 요소가 필요합니다.
- 이때 ghost 이미지를 활용합니다.

```js
function showFail($args, $next){
    moveGhost($args.event, $next);
}

// Ghost 이미지 이동이 끝난 후 종료
function moveGhost(event, $next){
    // ghost 이미지 삭제를 방지하기 위해 preventDefault 호출
    event.preventDefault();
    const position = event.detail.position;
    
    // ghost 객체 참조
    const ghost = event.detail.ghost;
    // ghost 객체는 document.body에 append되어 있으므로
    // 이동량을 Global 좌표에 투영하려면
    // 화면에 적용된 scale도 고려해 줘야함
    const scale = position.scale;

    // 현재 ghost 위치에서 이동량만큼 역으로 tween 시켜줌
    const to = {
        x: (-position.end.dist.x) * scale,
        y: (-position.end.dist.y) * scale,
        // 이동이 끝나면 ghost 삭제
        onComplete: () => {
            ghost.remove();
            $next();
        }
    }
    gsap.to(ghost, to);
}
```


















